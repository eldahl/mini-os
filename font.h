#ifndef FONT_H
#define FONT_H

#include "types.h"
#include "graphics.h"

// ============================================================================
// BITMAP FONT RENDERING FOR MINI-OS
// 8x8 pixel bitmap font with full ASCII printable character set
// ============================================================================

#define FONT_WIDTH  8
#define FONT_HEIGHT 8
#define FONT_FIRST_CHAR 32   // Space
#define FONT_LAST_CHAR  126  // Tilde

// 8x8 bitmap font data - each character is 8 bytes (one byte per row)
static const uint8_t font_data[95][8] = {
    // Space (32)
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // ! (33)
    { 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00 },
    // " (34)
    { 0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // # (35)
    { 0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00 },
    // $ (36)
    { 0x18, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x18, 0x00 },
    // % (37)
    { 0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00 },
    // & (38)
    { 0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00 },
    // ' (39)
    { 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // ( (40)
    { 0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00 },
    // ) (41)
    { 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00 },
    // * (42)
    { 0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00 },
    // + (43)
    { 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00 },
    // , (44)
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30 },
    // - (45)
    { 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00 },
    // . (46)
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00 },
    // / (47)
    { 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00 },
    // 0 (48)
    { 0x7C, 0xC6, 0xCE, 0xD6, 0xE6, 0xC6, 0x7C, 0x00 },
    // 1 (49)
    { 0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00 },
    // 2 (50)
    { 0x7C, 0xC6, 0x06, 0x1C, 0x30, 0x66, 0xFE, 0x00 },
    // 3 (51)
    { 0x7C, 0xC6, 0x06, 0x3C, 0x06, 0xC6, 0x7C, 0x00 },
    // 4 (52)
    { 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00 },
    // 5 (53)
    { 0xFE, 0xC0, 0xC0, 0xFC, 0x06, 0xC6, 0x7C, 0x00 },
    // 6 (54)
    { 0x38, 0x60, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00 },
    // 7 (55)
    { 0xFE, 0xC6, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00 },
    // 8 (56)
    { 0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00 },
    // 9 (57)
    { 0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0x78, 0x00 },
    // : (58)
    { 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00 },
    // ; (59)
    { 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30 },
    // < (60)
    { 0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00 },
    // = (61)
    { 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00 },
    // > (62)
    { 0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00 },
    // ? (63)
    { 0x7C, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00 },
    // @ (64)
    { 0x7C, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0x78, 0x00 },
    // A (65)
    { 0x38, 0x6C, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00 },
    // B (66)
    { 0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00 },
    // C (67)
    { 0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00 },
    // D (68)
    { 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00 },
    // E (69)
    { 0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00 },
    // F (70)
    { 0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00 },
    // G (71)
    { 0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3A, 0x00 },
    // H (72)
    { 0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00 },
    // I (73)
    { 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // J (74)
    { 0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00 },
    // K (75)
    { 0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00 },
    // L (76)
    { 0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00 },
    // M (77)
    { 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0x00 },
    // N (78)
    { 0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00 },
    // O (79)
    { 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00 },
    // P (80)
    { 0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00 },
    // Q (81)
    { 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xCE, 0x7C, 0x0E },
    // R (82)
    { 0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00 },
    // S (83)
    { 0x7C, 0xC6, 0xE0, 0x78, 0x0E, 0xC6, 0x7C, 0x00 },
    // T (84)
    { 0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // U (85)
    { 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00 },
    // V (86)
    { 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00 },
    // W (87)
    { 0xC6, 0xC6, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00 },
    // X (88)
    { 0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00 },
    // Y (89)
    { 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x00 },
    // Z (90)
    { 0xFE, 0xC6, 0x8C, 0x18, 0x32, 0x66, 0xFE, 0x00 },
    // [ (91)
    { 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00 },
    // \ (92)
    { 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00 },
    // ] (93)
    { 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00 },
    // ^ (94)
    { 0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    // _ (95)
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF },
    // ` (96)
    { 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // a (97)
    { 0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0x76, 0x00 },
    // b (98)
    { 0xE0, 0x60, 0x7C, 0x66, 0x66, 0x66, 0xDC, 0x00 },
    // c (99)
    { 0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00 },
    // d (100)
    { 0x1C, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00 },
    // e (101)
    { 0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00 },
    // f (102)
    { 0x38, 0x6C, 0x60, 0xF8, 0x60, 0x60, 0xF0, 0x00 },
    // g (103)
    { 0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0xF8 },
    // h (104)
    { 0xE0, 0x60, 0x6C, 0x76, 0x66, 0x66, 0xE6, 0x00 },
    // i (105)
    { 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // j (106)
    { 0x06, 0x00, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C },
    // k (107)
    { 0xE0, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0xE6, 0x00 },
    // l (108)
    { 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // m (109)
    { 0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xD6, 0x00 },
    // n (110)
    { 0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x00 },
    // o (111)
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00 },
    // p (112)
    { 0x00, 0x00, 0xDC, 0x66, 0x66, 0x7C, 0x60, 0xF0 },
    // q (113)
    { 0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0x1E },
    // r (114)
    { 0x00, 0x00, 0xDC, 0x76, 0x60, 0x60, 0xF0, 0x00 },
    // s (115)
    { 0x00, 0x00, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x00 },
    // t (116)
    { 0x30, 0x30, 0xFC, 0x30, 0x30, 0x36, 0x1C, 0x00 },
    // u (117)
    { 0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00 },
    // v (118)
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00 },
    // w (119)
    { 0x00, 0x00, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00 },
    // x (120)
    { 0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00 },
    // y (121)
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0xFC },
    // z (122)
    { 0x00, 0x00, 0xFE, 0x8C, 0x18, 0x32, 0xFE, 0x00 },
    // { (123)
    { 0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00 },
    // | (124)
    { 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00 },
    // } (125)
    { 0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00 },
    // ~ (126)
    { 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
};

// ---------- Character rendering ----------
static inline void font_draw_char(int x, int y, char c, Color fg, int scale) {
    if (c < FONT_FIRST_CHAR || c > FONT_LAST_CHAR) return;
    
    const uint8_t* glyph = font_data[c - FONT_FIRST_CHAR];
    
    for (int row = 0; row < FONT_HEIGHT; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < FONT_WIDTH; col++) {
            if (bits & (0x80 >> col)) {
                if (scale == 1) {
                    gfx_put_pixel(x + col, y + row, fg);
                } else {
                    gfx_fill_rect(x + col * scale, y + row * scale, scale, scale, fg);
                }
            }
        }
    }
}

static inline void font_draw_char_bg(int x, int y, char c, Color fg, Color bg, int scale) {
    if (c < FONT_FIRST_CHAR || c > FONT_LAST_CHAR) {
        gfx_fill_rect(x, y, FONT_WIDTH * scale, FONT_HEIGHT * scale, bg);
        return;
    }
    
    const uint8_t* glyph = font_data[c - FONT_FIRST_CHAR];
    
    for (int row = 0; row < FONT_HEIGHT; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < FONT_WIDTH; col++) {
            Color color = (bits & (0x80 >> col)) ? fg : bg;
            if (scale == 1) {
                gfx_put_pixel(x + col, y + row, color);
            } else {
                gfx_fill_rect(x + col * scale, y + row * scale, scale, scale, color);
            }
        }
    }
}

// ---------- String rendering ----------
static inline int font_draw_string(int x, int y, const char* str, Color fg, int scale) {
    int start_x = x;
    while (*str) {
        if (*str == '\n') {
            x = start_x;
            y += FONT_HEIGHT * scale + scale;
        } else {
            font_draw_char(x, y, *str, fg, scale);
            x += FONT_WIDTH * scale;
        }
        str++;
    }
    return x;
}

static inline void font_draw_string_bg(int x, int y, const char* str, Color fg, Color bg, int scale) {
    int start_x = x;
    while (*str) {
        if (*str == '\n') {
            x = start_x;
            y += FONT_HEIGHT * scale + scale;
        } else {
            font_draw_char_bg(x, y, *str, fg, bg, scale);
            x += FONT_WIDTH * scale;
        }
        str++;
    }
}

static inline void font_draw_string_centered(int cx, int y, const char* str, Color fg, int scale) {
    int len = 0;
    const char* p = str;
    while (*p) { len++; p++; }
    int width = len * FONT_WIDTH * scale;
    font_draw_string(cx - width / 2, y, str, fg, scale);
}

static inline void font_draw_string_right(int right_x, int y, const char* str, Color fg, int scale) {
    int len = 0;
    const char* p = str;
    while (*p) { len++; p++; }
    int width = len * FONT_WIDTH * scale;
    font_draw_string(right_x - width, y, str, fg, scale);
}

// ---------- Number rendering ----------
static inline void int_to_str(int value, char* buf) {
    if (value == 0) {
        buf[0] = '0';
        buf[1] = '\0';
        return;
    }
    
    int negative = 0;
    if (value < 0) {
        negative = 1;
        value = -value;
    }
    
    char temp[12];
    int i = 0;
    while (value > 0) {
        temp[i++] = '0' + (value % 10);
        value /= 10;
    }
    
    int j = 0;
    if (negative) buf[j++] = '-';
    while (i > 0) buf[j++] = temp[--i];
    buf[j] = '\0';
}

static inline void font_draw_int(int x, int y, int value, Color fg, int scale) {
    char buf[12];
    int_to_str(value, buf);
    font_draw_string(x, y, buf, fg, scale);
}

static inline void uint_to_hex(uint32_t value, char* buf) {
    const char hex[] = "0123456789ABCDEF";
    buf[0] = '0';
    buf[1] = 'x';
    for (int i = 7; i >= 0; i--) {
        buf[2 + (7 - i)] = hex[(value >> (i * 4)) & 0xF];
    }
    buf[10] = '\0';
}

static inline void font_draw_hex(int x, int y, uint32_t value, Color fg, int scale) {
    char buf[11];
    uint_to_hex(value, buf);
    font_draw_string(x, y, buf, fg, scale);
}

// ---------- Text effects ----------
static inline void font_draw_string_shadow(int x, int y, const char* str, Color fg, Color shadow, int scale, int offset) {
    font_draw_string(x + offset, y + offset, str, shadow, scale);
    font_draw_string(x, y, str, fg, scale);
}

static inline void font_draw_string_outline(int x, int y, const char* str, Color fg, Color outline, int scale) {
    for (int dy = -1; dy <= 1; dy++) {
        for (int dx = -1; dx <= 1; dx++) {
            if (dx != 0 || dy != 0) {
                font_draw_string(x + dx * scale, y + dy * scale, str, outline, scale);
            }
        }
    }
    font_draw_string(x, y, str, fg, scale);
}

static inline void font_draw_text_box(int x, int y, int w, int h, const char* str, Color fg, Color bg, Color border, int scale) {
    gfx_fill_rect(x, y, w, h, bg);
    gfx_draw_rect(x, y, w, h, border);
    int padding = 4 * scale;
    font_draw_string(x + padding, y + padding, str, fg, scale);
}

static inline int str_len(const char* str) {
    int len = 0;
    while (*str++) len++;
    return len;
}

#endif // FONT_H
